# File Upload with Service Workers

Test of file upload with Service Workers.

Service Worker を使って、サーバへのファイルアップロードを試します。UI とは異なるスレッドで動作するため、シングルページアプリケーションではない通常のページ遷移を行ったり、実行中にウインドウを閉じたりしても、バックグラウンドでアップロードが続行される様子を確認できます。

## 機能

### UI スレッドにおける Fetch API によるアップロード

アップロードが正常に実行されることを確認するためのものです。アップロードが完了すると、画面上にサーバからのレスポンスを表示します。

### Service Worker における Fetch API によるアップロード

UI とは異なるスレッドでアップロードを実行します。アップロードが完了すると、以下の 3 通りの方法でサーバからのレスポンスを返し、それを画面上に表示します。

- **`MessageChannel`** — `MessageChannel` を使って相手とデータの送受信を行える 2 つの `MessagePort` を作成し、往路は UI から Service Worker へ、復路は Service Worker から UI へとデータを流します。ページ遷移等で UI のライフサイクルが破棄されると、Service Worker からの受信はできなくなります。
- **Service Worker から全クライアントへの `postMessage`** — Service Worker をコントロールしている全クライアントへメッセージを送信します。コントロール状態でなければイベントを購読できませんが、コントロール状態であればページ遷移後もイベントを購読することで、Service Worker からのメッセージを受信できます。
- **通知** — Notifications API を使って、ブラウザからユーザへ通知を送信します。あらかじめユーザからの許可を受けていれば、たとえウインドウを閉じてしまっても、アップロードが完了したことを Service Worker からの通知によって知ることができます。

## 準備

最初に Docker（Compose 含む）をインストールしてください。

その後、`prepare.sh` を実行してください。Node.js のコンテナを起動して、依存ライブラリをインストールします。また、このとき環境変数を設定するファイル `.env` も作成されます。変数は次の通りです。

- **`PORT`** — サーバ（コンテナ）・ホスト間のポート番号。初期値は `8080` です。

## 起動

`start.sh` を実行してください。Node.js のコンテナを起動して、サーバを起動します。Web ブラウザから `localhost:8080`（ポート番号は `PORT` の値）にアクセスすると、トップページが表示されます。

なお、サーバを終了するとコンテナも自動的に削除されます。

## License

See [LICENSE](../LICENSE).
